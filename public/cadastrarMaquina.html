<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/logo sem fundo.png" sizes="16x16">
    <link rel="stylesheet" href="css/cadastrarMaquina.css" />
    <title>Cadastro de Máquina | Helpers Solutions</title>
    <script src="js/script.js" defer></script>
    <script src="js/validacao.js" defer></script>
  </head>
  <body onload="menuLateral(), carregarSetores()">
    <div class="sideBar">
      <div class="sidebarTop">
        <h1 class="title">Helpers</h1>
        <div class="boxProfile">
          <img class="imgProfile" src="assets/user white.png" alt="">
          <div class="nomes">
            <h2 class="nomeEmpresa" id="nomeEmpresa"></h2>
            <h3 class="nomeUsuario" id="nomeUsuario"></h3>
          </div>
        </div>
      </div>
      <div class="navBar">
        <a href="dashboard.html" >Visão Geral</a>
        <a href="relatorios.html">Logs</a>
        <a href="cadastrarMaquina.html" class="agora">Cadastrar Máquinas</a>
        <a href="formsSuporte.html">Suporte Técnico</a>
        <a class="btnSair" id="btn_sair" onclick="limparSessao()">Sair</a>
      </div>
    </div>
      <div class="main">
        <div class="box_cadastroMaquina">
            <span class="span_tituloPrincipal">Cadastrar Máquina</span>

            <div class="box_inputs">
                <span class="span_titulos">Nome:</span>
                <input type="text" id="iptNomeMaquina" class="input_valores">
                
                <span class="span_titulos">Número do Setor:</span>
                <select id="sltSetor" class="slt_tpMaquina">
                </select>
    
                <span class="span_titulos">Tipo da Máquina:</span>
                <select class="slt_tpMaquina" id="sltMaquina">
                    <option value="#" selected disabled>Selecione Uma Máquina</option>
                    <option value="axial">Bomba Axial</option>
                    <option value="centrifuga">Bomba Centrífuga</option>
                    <option value="deslocamentoPositivo">Bomba de Deslocamento Positivo</option>
                </select><br>
                
                <span class="span_titulos">Temperatura Máxima de Operação:</span>
                <input type="text" id="iptTempMaxima" class="input_valores">
    
                <span class="span_titulos">Temperatura Mínima de Operação:</span>
                <input type="text" id="iptTempMinima" class="input_valores">

                <button onclick="cadastrarMaquina()" class="btn_cadastrar" id="btn_cadastrar">Cadastrar</a>
            </div>
        </div>

      </div>
</body>
</html>
<script>
  lista_setores = []
async function carregarSetores() {
  try {
    // Obtém o idEmpresa do sessionStorage
    const idEmpresa = sessionStorage.getItem('ID_EMPRESA');

    // Verifica se o idEmpresa está presente no sessionStorage
    if (!idEmpresa) {
        console.error('ID da empresa não encontrado no sessionStorage');
        return;
    }

    // Faz a requisição para a rota que retorna os setores
    const response = await fetch(`/dashboard/setores/${idEmpresa}`);
    
    // Verifica se a resposta foi bem-sucedida
    if (!response.ok) {
        throw new Error('Erro ao obter setores');
    }

    // Converte a resposta para JSON
    const data = await response.json();

    // Verifica se há setores na resposta
    if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
        // Seleciona o elemento <select> pelo ID
        const selectElement = document.getElementById('sltSetor');

        // Limpa o conteúdo do <select> antes de adicionar novas opções
        selectElement.innerHTML = '';

        // Adiciona uma opção para cada setor
        data.data.forEach(setor => {
            const option = document.createElement('option');
            option.value = setor.idSetor;  // O valor da opção é o id do setor
            option.textContent = setor.Nome;  // O texto da opção é o nome do setor
            lista_setores.push(setor.Nome)
            selectElement.appendChild(option);
        });

        // Chama a função para preencher as máquinas e carregar o gráfico com o setor selecionado
        const idSetor = selectElement.value; // Pegue o valor do setor selecionado
        await preencherSelect(idSetor); 
        await grafico1(1)// Chama para preencher as máquinas e carregar o gráfico

    } else {
        
    }
  } catch (error) {
    console.error('Erro ao carregar setores:', error);
  }
}

// Esta função preencherá o select com as máquinas e fará a consulta ao gráfico
async function preencherSelect(idSetor) {
  try {
    // Faz a requisição para obter as máquinas do setor
    const response = await fetch(`/dashboard/maquinas/${idSetor}`);
    
    if (!response.ok) {
      throw new Error(`Erro na requisição: ${response.statusText}`);
    }

    const data = await response.json();
  
    // Seleciona o elemento <select> para preencher
    const select = document.getElementById('sltSensor');
    select.innerHTML = ''; // Limpa o conteúdo atual do select
    
    // Preenche o select com as máquinas
    data.data.forEach((maquina, index) => {
      const option = document.createElement('option');
      option.value = maquina.idMaquina;
      option.textContent = maquina.nome;
      
      // Marca a primeira opção como selecionada
      if (index === 0) {
        option.selected = true;
      }
      select.appendChild(option);
    });

    // Depois de preencher o select, chama a função para carregar o gráfico com o primeiro valor
    const value = select.value;
    await sensorChange(value); // Chama a função de mudança de sensor para carregar o gráfico
    await grafico2(idSetor)
  } catch (error) {
    console.error('Erro ao preencher o select:', error);
  }
}

</script>